pipeline {
    agent none
    
    parameters {
        string(name:'TAG_NAME',defaultValue: '',description:'')
    }

    environment {
        DOCKER_CREDENTIAL_ID = 'dockerhub-id'
        GITHUB_CREDENTIAL_ID = 'github-id'
        KUBECONFIG_CREDENTIAL_ID = 'demo-kubeconfig'
        REGISTRY = 'docker.io'
        DOCKERHUB_NAMESPACE = 'docker_username'
        GITHUB_ACCOUNT = 'eachchat'
        APP_NAME = 'eachchat-desktop'
        SONAR_CREDENTIAL_ID = 'sonar-token'
    }

    stages{
            stage('window build'){
                agent {
                    label 'eachchat-desktop-win10'
                }
                
                steps {
                    checkout(scm)

                    withCredentials([string(credentialsId: "$SONAR_CREDENTIAL_ID", variable: 'SONAR_TOKEN')]) {
                        withSonarQubeEnv('sonar') {
                            sonar-scanner.bat -D"sonar.projectKey=eachchat-desktop" -D"sonar.sources=./prj" -D"sonar.host.url=http://103.61.37.73:30610" -D"sonar.login=8c326403bae435be96bc5e4eb82a257e3ea91fdf"
                        }
                    }
                    timeout(time: 1, unit: 'HOURS') {
                        waitForQualityGate abortPipeline: true
                    }

                    bat '''
                    cd ./prj
                    yarn run build
                    '''
                }
                
                post {
                    failure {
                        mail to: 'chengfang@workly.ai',
                        subject: "Window Failed Pipeline: ${currentBuild.fullDisplayName}",
                        body: "${env.BUILD_URL}"
                    }
                    success {
                        mail to: 'chengfang@workly.ai',
                        subject: 'Window Successed Pipeline: ${currentBuild.fullDisplayName}',
                        body: "${env.BUILD_URL}"
                    }
                }              
            }
    }
}


