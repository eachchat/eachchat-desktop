pipeline {
    agent none
    
    parameters {
        string(name:'TAG_NAME',defaultValue: '',description:'')
    }

    environment {
        DOCKER_CREDENTIAL_ID = 'dockerhub-id'
        GITHUB_CREDENTIAL_ID = 'github-id'
        KUBECONFIG_CREDENTIAL_ID = 'demo-kubeconfig'
        REGISTRY = 'docker.io'
        DOCKERHUB_NAMESPACE = 'docker_username'
        GITHUB_ACCOUNT = 'eachchat'
        APP_NAME = 'eachchat-desktop'
        SONAR_CREDENTIAL_ID = 'sonar-token'
    }

    stages{
            stage('mac build'){
                agent {
                    label 'eachchat-desktop-mac'
                }
                
                steps {
                    checkout(scm)

                    withCredentials([string(credentialsId: "$SONAR_CREDENTIAL_ID", variable: 'SONAR_TOKEN')]) {
                        withSonarQubeEnv('sonar') {
                            sh '/Users/jenkins/Desktop/sonar-scanner-4.6.2.2472-macosx/bin/sonar-scanner \
                            -Dsonar.projectKey=eachchat-desktop \
                            -Dsonar.sources=prj/src \
                            -Dsonar.host.url=http://192.168.14.25:30244 \
                            -Dsonar.login="$sonar-token"'
                        }
                    }
                    timeout(time: 1, unit: 'HOURS') {
                        waitForQualityGate abortPipeline: true
                    }

                    sh '''
                    cd ./prj
                    yarn run build
                    yarn test
                    '''
                }
                
                post {
                    failure {
                        mail to: 'chengfang@workly.ai',
                        subject: "Window Failed Pipeline: ${currentBuild.fullDisplayName}",
                        body: "${env.BUILD_URL}"
                    }
                    success {
                        mail to: 'chengfang@workly.ai',
                        subject: 'Window Successed Pipeline: ${currentBuild.fullDisplayName}',
                        body: "${env.BUILD_URL}"
                    }
                }              
            }
    }
}


